# MM(Market Maker) 의무이행률 분석 프로세스 해설서

> 이 문서는 DS투자증권 MM 의무이행률 분석 시스템의 핵심 로직을 비개발자도 이해할 수 있도록 설명합니다.

---

## 목차

1. [배경: MM이란 무엇인가?](#1-배경-mm이란-무엇인가)
2. [핵심 문제: 왜 분석이 어려운가?](#2-핵심-문제-왜-분석이-어려운가)
3. [분석 로직 1: 100ms 윈도우 페어링](#3-분석-로직-1-100ms-윈도우-페어링)
4. [분석 로직 2: 의무수량(Q) 배수 필터링](#4-분석-로직-2-의무수량q-배수-필터링)
5. [분석 로직 3: MM1/MM2 개별 추적](#5-분석-로직-3-mm1mm2-개별-추적)
6. [분석 로직 4: 델타 패턴 기반 퇴장 감지](#6-분석-로직-4-델타-패턴-기반-퇴장-감지)
7. [분석 로직 5: 조용한 퇴장 감지](#7-분석-로직-5-조용한-퇴장-감지)
8. [의무이행률 계산 방법](#8-의무이행률-계산-방법)
9. [한계점 및 향후 개선 방향](#9-한계점-및-향후-개선-방향)

---

## 1. 배경: MM이란 무엇인가?

### 시장조성자(Market Maker)의 역할

시장조성자(MM)는 옵션 시장에서 **유동성을 공급**하는 역할을 합니다. 쉽게 말해, 사고 싶은 사람과 팔고 싶은 사람이 없을 때에도 MM이 매수/매도 호가를 제시하여 거래가 가능하도록 합니다.

### MM의 의무

- **의무시간**: 09:05:00 ~ 15:20:00 (총 375분 = 22,500초)
- **의무 호가 제시**: 매수호가(Bid)와 매도호가(Ask)를 **동시에** 제시해야 함
- **의무수량(Q)**: 각 옵션별로 정해진 최소 수량 이상을 제시해야 함
- **의무이행률 기준**: 일중 85% 이상 (의무시간 중 85% 이상 호가를 제시해야 함)

### 2개 MM 체제

각 주식옵션에는 **2개의 MM 회사**가 배정됩니다. 예를 들어:
- KT 옵션: DS투자증권 + 키움증권
- 삼성화재 옵션: DS투자증권 + 하나증권

---

## 2. 핵심 문제: 왜 분석이 어려운가?

### 문제 1: 호가 데이터에는 "누구의 호가인지" 표시되지 않음

거래소에서 받는 호가 데이터(로그)에는 **총 매수잔량**, **총 매도잔량**만 기록됩니다. 어느 증권사가 제시한 호가인지는 **전혀 알 수 없습니다**.

```
예시: 어떤 시점의 호가 상황
- 매도호가 1단계 잔량: 150계약
- 매수호가 1단계 잔량: 120계약

→ 이 중 얼마가 DS투자증권 것인지, 키움증권 것인지 알 수 없음
```

### 문제 2: MM의 진입/퇴장 시점을 직접 알 수 없음

MM이 "지금 호가를 제시했어요" 또는 "지금 호가를 취소했어요"라고 알려주지 않습니다. 우리는 **잔량의 변화**만 볼 수 있습니다.

### 해결 방향

MM만의 **고유한 행동 패턴**을 찾아서, 해당 패턴이 감지되면 "이건 MM의 행동이다"라고 **추정**합니다.

---

## 3. 분석 로직 1: 100ms 윈도우 페어링

### 초기 가설

> "MM은 매수호가와 매도호가를 **거의 동시에** 제출할 것이다"

MM은 의무상 매수/매도를 동시에 제시해야 하므로, 시스템적으로 두 주문을 거의 같은 시간에 넣을 것입니다.

### 문제점 발견

호가 로그를 분석해보니, **한 줄의 로그에 매수와 매도가 같이 기록되어 있지 않았습니다**. 매수 변화와 매도 변화가 **별도의 로그**로 기록됩니다.

```
예시:
09:05:00.123 - 매도잔량 변화: +27
09:05:00.125 - 매수잔량 변화: +27  (2ms 후)
```

### 적용 로직

**100ms(0.1초) 이내**에 발생한 매수 변화와 매도 변화가 있으면, 이를 **하나의 MM 행동으로 묶어서(페어링)** 처리합니다.

```
적용 기준:
- 시간 차이: 100ms 이내
- 변화 방향: 둘 다 증가(+) 또는 둘 다 감소(-)
- 변화 유형: 하나는 매수, 하나는 매도
```

### 왜 100ms인가?

- **10ms 이내**: 너무 짧음. 네트워크 지연으로 인해 놓치는 페어가 많음
- **1초 이상**: 너무 김. 관련 없는 두 이벤트가 잘못 연결될 수 있음
- **100ms**: 실험 결과 가장 적절한 균형점

---

## 4. 분석 로직 2: 의무수량(Q) 배수 필터링

### 초기 가설

> "MM은 정해진 의무수량(Q)의 **정확한 배수**로 호가를 제출할 것이다"

MM은 시스템화되어 있어서, 의무수량의 1배, 2배, 3배... 등 정확한 배수로 주문을 넣습니다. 반면 일반 투자자는 37계약, 52계약 등 불규칙한 수량으로 주문합니다.

### 예시

LG디스플레이 ATM 옵션의 의무수량(Q) = 27계약

```
MM의 호가 패턴 (예상):
- 27계약 (1Q)
- 54계약 (2Q)
- 81계약 (3Q)

일반 투자자의 호가 패턴 (예상):
- 15계약
- 42계약
- 100계약
```

### 적용 로직

호가 잔량의 변화량이 **Q의 배수**인 경우에만 MM의 행동으로 간주합니다.

```python
# 의사 코드
if 변화량 % Q == 0:
    MM의_행동으로_판단()
else:
    일반_투자자의_행동으로_무시()
```

### 왜 이 로직이 중요한가?

이 필터링을 통해 **노이즈(일반 투자자의 거래)를 제거**할 수 있습니다. Q 배수가 아닌 변화는 MM이 아닐 가능성이 높으므로 분석에서 제외합니다.

---

## 5. 분석 로직 3: MM1/MM2 개별 추적

### 초기 가설

> "2개의 MM이 있으므로, 각각의 상태를 개별적으로 추적해야 한다"

시장에는 2개의 MM이 있고, 각각 독립적으로 진입/퇴장합니다. 따라서 "현재 MM이 몇 개 있는가?"만 세는 것이 아니라, **"MM1은 진입 상태인가? MM2는 진입 상태인가?"**를 개별적으로 추적해야 합니다.

### MM1과 MM2 구분

- **MM1**: 먼저 진입한 MM
- **MM2**: 나중에 진입한 MM

누가 DS투자증권인지는 알 수 없지만, **진입 순서**로 구분합니다.

### 적용 로직

```
상태 추적:
- MM1 = None (없음) 또는 {진입 패턴}
- MM2 = None (없음) 또는 {진입 패턴}

진입 이벤트 발생 시:
- MM1이 없으면 → MM1에 기록
- MM1이 있고 MM2가 없으면 → MM2에 기록
- 둘 다 있으면 → 비정상 상황 (처리 필요)

퇴장 이벤트 발생 시:
- MM2가 있고 패턴이 일치하면 → MM2 퇴장
- MM1이 있고 패턴이 일치하면 → MM1 퇴장, MM2가 있으면 MM1 자리로 이동하지 않음
```

### 왜 "승격 없음" 정책인가?

초기에는 MM1이 퇴장하면 MM2를 MM1으로 승격시켰습니다. 하지만 이 방식은 **추적 오류**를 야기했습니다.

```
문제 상황:
09:30 - MM1 진입 (패턴 A)
09:35 - MM2 진입 (패턴 B)
09:40 - MM1 퇴장
09:45 - 패턴 B로 퇴장 시도

승격 있을 때: MM2가 MM1이 되었으므로 패턴 매칭 실패
승격 없을 때: MM2의 패턴 B와 정확히 일치, 정상 처리
```

---

## 6. 분석 로직 4: 델타 패턴 기반 퇴장 감지

### 초기 가설

> "MM이 퇴장할 때는, 진입할 때와 **정확히 반대되는 패턴**으로 퇴장할 것이다"

MM이 매도 54계약, 매수 54계약을 제시하며 진입했다면, 퇴장할 때도 매도 -54계약, 매수 -54계약으로 취소할 것입니다.

### 델타(Delta)란?

**델타 = 현재 잔량 - 이전 잔량**

즉, 잔량의 변화량입니다.

### 적용 로직

```
진입 시:
- 델타: 매도 +2Q, 매수 +2Q
- 저장: MM1 = {ask_q: 2, bid_q: 2}

퇴장 감지:
- 델타: 매도 -2Q, 매수 -2Q
- 비교: 저장된 MM1 패턴 (2, 2)의 음수 = (-2, -2)와 일치!
- 결론: MM1 퇴장
```

### 왜 패턴 매칭이 필요한가?

단순히 "잔량이 줄었다"만으로는 **어떤 MM이 퇴장했는지** 알 수 없습니다. 진입 시 저장한 패턴과 비교해야 정확히 구분할 수 있습니다.

```
상황 예시:
- MM1 진입: 3Q, 3Q
- MM2 진입: 2Q, 2Q
- 퇴장 발생: -2Q, -2Q

→ MM2의 패턴과 일치하므로 MM2가 퇴장한 것으로 판단
```

---

## 7. 분석 로직 5: 조용한 퇴장 감지

### 초기 가설

> "MM이 이미 퇴장했는데, 우리가 감지하지 못한 경우가 있을 것이다"

모든 퇴장이 깔끔하게 감지되지는 않습니다. 시장 상황에 따라 **조용히 퇴장**하는 경우가 있습니다.

### 문제 상황

```
현재 상태: MM1, MM2 모두 진입 중 (2MM 상태)
새 이벤트: +3Q, +3Q 진입 패턴 감지

→ 이미 2명이 있는데 또 진입? 불가능!
→ 결론: 누군가 조용히 퇴장했음
```

### 적용 로직

이미 2MM 상태에서 새로운 진입 패턴이 감지되면:

1. **조용한 퇴장 발생**으로 기록
2. 기존 MM 중 하나를 퇴장 처리 (일반적으로 MM2)
3. 새로운 진입 기록

### 한계점

조용한 퇴장이 **언제 발생했는지** 정확히 알 수 없습니다. 새 진입이 감지된 시점에서야 "아, 누군가 나갔구나"를 알게 됩니다.

---

## 8. 의무이행률 계산 방법

### 시간대별 MM 상태 기록

분석 과정에서 **타임라인**을 구성합니다:

```
09:05:00 - 0MM (아무도 없음)
09:05:15 - 1MM (MM1 진입)
09:07:30 - 2MM (MM2 진입)
09:45:00 - 1MM (MM2 퇴장)
10:20:00 - 2MM (MM2 재진입)
...
15:20:00 - 의무시간 종료
```

### 시간 계산

각 상태별로 **지속 시간**을 계산합니다:

```
0MM 시간: 15초 (09:05:00 ~ 09:05:15)
1MM 시간: 135초 (09:05:15 ~ 09:07:30)
2MM 시간: 22350초 (나머지)
```

### 의무이행률 계산

```
MM1 의무이행률 = (1MM 시간 + 2MM 시간) / 전체 의무시간 × 100%
MM2 의무이행률 = (2MM 시간) / 전체 의무시간 × 100%
```

**해석**:
- **MM1 의무이행률**: MM1이 호가를 제시하고 있던 시간의 비율
- **MM2 의무이행률**: MM1과 MM2가 **동시에** 호가를 제시하고 있던 시간의 비율

---

## 9. 한계점 및 향후 개선 방향

### 현재 한계점

#### 1. MM 식별 불가
- 누가 DS투자증권인지, 누가 파트너사인지 **확정할 수 없음**
- 분석 결과에서 MM1/MM2 중 KRX 실제값과 가까운 쪽을 "우리 회사"로 **추정**

#### 2. 일부 옵션에서 큰 오차
- LG전자 CALL ATM: 실제 92%, 분석 37% (오차 -55%)
- 원인 추정: 해당 옵션의 거래 패턴이 일반적이지 않거나, Q값 설정 문제

#### 3. 패킷 수가 적은 옵션
- 카카오뱅크 PUT OTM4: 56개 패킷만 존재
- 데이터가 부족하여 정확한 분석 불가

### 향후 개선 방향

1. **실시간 분석**: 현재는 일별 사후 분석이지만, 실시간으로 전환 가능
2. **Q값 자동 보정**: 분석 결과와 실제 결과의 차이를 기반으로 Q값 조정
3. **머신러닝 적용**: 더 복잡한 패턴 인식을 위한 ML 모델 도입 검토
4. **비정상 상황 알림**: 의무이행률이 낮아지면 실시간 경고

---

## 부록: 용어 설명

| 용어 | 설명 |
|------|------|
| MM (Market Maker) | 시장조성자. 호가를 제시하여 유동성을 공급하는 역할 |
| Ask (매도호가) | 팔려고 내놓은 가격과 수량 |
| Bid (매수호가) | 사려고 내놓은 가격과 수량 |
| Q (의무수량) | 각 옵션별로 정해진 최소 호가 제시 수량 |
| ATM (At The Money) | 현재 기초자산 가격과 행사가가 같은 옵션 |
| OTM (Out of The Money) | 현재 가치가 없는(외가격) 옵션 |
| ITM (In The Money) | 현재 가치가 있는(내가격) 옵션 |
| 델타 (Delta) | 잔량의 변화량 (현재 - 이전) |
| 페어링 (Pairing) | 매수/매도 변화를 하나의 행동으로 묶는 것 |
| ISIN | 국제 증권 식별 번호 (각 옵션의 고유 코드) |

---

## 부록: 분석 파일 구조

```
analysis_workspace/
├── mm_config.py                    # 설정 파일 (종목, Q값, 의무시간 등)
├── mm_full_analysis_verified.py    # 메인 분석 스크립트
├── MM_분석_프로세스_해설서.md        # 이 문서
├── results/
│   └── 2026-01-22/
│       ├── mm_analysis_result_2026-01-22.md      # 72개 옵션 분석 결과
│       └── mm_krx_comparison_2026-01-22.md       # KRX 실제값 비교
├── data/                           # 분석용 데이터 파일
└── archive/                        # 이전 버전 스크립트 보관
```

---

*문서 작성일: 2026-01-27*
*작성: MM 분석 시스템*
